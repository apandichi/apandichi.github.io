<!DOCTYPE html>

<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">

  <title>Testing Cordova SQLite queries with Web SQL - (Not only) Java software developer</title>

  <meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="viewport" content="width=device-width, initial-scale=1">



<link rel="icon" type="image/png" href="../assets/img/favicon-32x32.png?v=wAAv6Wqe6l" sizes="32x32">
<link rel="icon" type="image/png" href="../assets/img/favicon-96x96.png?v=wAAv6Wqe6l" sizes="96x96">
<link rel="icon" type="image/png" href="../assets/img/favicon-16x16.png?v=wAAv6Wqe6l" sizes="16x16">
<link rel="manifest" href="../assets/img/manifest.json?v=wAAv6Wqe6l">
<link rel="shortcut icon" href="../assets/img/favicon.ico?v=wAAv6Wqe6l">
<meta name="msapplication-TileColor" content="#e74c3c">
<meta name="msapplication-TileImage" content="/assets/img/mstile-144x144.png?v=wAAv6Wqe6l">
<meta name="msapplication-config" content="/assets/img/browserconfig.xml?v=wAAv6Wqe6l">
<meta name="theme-color" content="#e74c3c">

  <link rel="stylesheet" type="text/css" href="../assets/css/uno.css?v=3c08806173">

  <link rel="canonical" href="index.html">
    
    <meta property="og:site_name" content="(Not only) Java software developer">
    <meta property="og:type" content="article">
    <meta property="og:title" content="Testing Cordova SQLite queries with Web SQL">
    <meta property="og:description" content="Once you start writing SQL queries for your Cordova application, you need to start thinking about how to make sure they work as expected. You'd want to test them in an automated fashion, but you're not ready to invest into...">
    <meta property="og:url" content="http://apandichi.github.io/testing-cordova-sqlite-queries-with-websql/">
    <meta property="article:published_time" content="2015-11-15T10:53:43.548Z">
    <meta property="article:modified_time" content="2015-11-15T11:15:35.893Z">
    <meta property="article:tag" content="cordova">
    <meta property="article:tag" content="sqlite">
    <meta property="article:tag" content="websql">
    
    <meta name="twitter:card" content="summary">
    <meta name="twitter:title" content="Testing Cordova SQLite queries with Web SQL">
    <meta name="twitter:description" content="Once you start writing SQL queries for your Cordova application, you need to start thinking about how to make sure they work as expected. You'd want to test them in an automated fashion, but you're not ready to invest into...">
    <meta name="twitter:url" content="http://apandichi.github.io/testing-cordova-sqlite-queries-with-websql/">
    
    <script type="application/ld+json">
{
    "@context": "http://schema.org",
    "@type": "Article",
    "publisher": "(Not only) Java software developer",
    "author": {
        "@type": "Person",
        "name": "Alin Pandichi",
        "image": "//www.gravatar.com/avatar/65bad1c5bba1746ca9be21442332b8ac?s=250&d=mm&r=x",
        "url": "http://apandichi.github.io/author/alin",
        "sameAs": null,
        "description": null
    },
    "headline": "Testing Cordova SQLite queries with Web SQL",
    "url": "http://apandichi.github.io/testing-cordova-sqlite-queries-with-websql/",
    "datePublished": "2015-11-15T10:53:43.548Z",
    "dateModified": "2015-11-15T11:15:35.893Z",
    "keywords": "cordova, sqlite, websql",
    "description": "Once you start writing SQL queries for your Cordova application, you need to start thinking about how to make sure they work as expected. You&#x27;d want to test them in an automated fashion, but you&#x27;re not ready to invest into..."
}
    </script>

    <meta name="generator" content="Ghost 0.6">
    <link rel="alternate" type="application/rss+xml" title="(Not only) Java software developer" href="../rss/index.html">
    <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-67007741-1', 'auto');
  ga('send', 'pageview');

</script>

</head>
<body class="post-template tag-cordova tag-sqlite tag-websql">

  <section id="menu-button" class="expanded">
    <a><i class="icon icon-list"></i></a>
  </section>

  <aside class="cover">

  <div class="cover container">
    <div class="profile">
      <a id="avatar-link" title="" href="../index.html#open">
        <img src="../content/images/2015/08/headshot.jpeg" alt="(Not only) Java software developer avatar" class="profile avatar hvr-buzz-out">
        <h1>Alin Pandichi</h1>
        <h3 id="profile-resume">(Not only) Java software developer</h3>
      </a>

      <hr class="divider long">
      <p>(Not only) Java software developer</p>
      <hr class="divider short">
      <div class="navigation">
        <div class="profile contact">
          <nav class="navigation left">
  <ul class="links">
    <li class="links item">
      <a href="../index.html#open" class="link-item" title="" id="blog-button">Blog</a>
      <a href="../about/" class="link-item" title="" id="tags-button">About me</a>
    </li>
  </ul>
</nav>
          
<nav class="navigation right">
  <ul class="social expanded">

  <!-- Twitter -->
  <li class="social item hvr-grow-rotate">
    <a target="blank" href="http://twitter.com/alinpandichi" title="Alin Pandichi on Twitter">
      <i class="icon icon-social-twitter"></i>
      <span class="label">Twitter</span>
    </a>
  </li>

  <!-- Github -->
  <li class="social item hvr-grow-rotate">
    <a target="blank" href="https://github.com/apandichi" title="Alin Pandichi on Github">
      <i class="icon icon-social-github"></i>
      <span class="label">Github</span>
    </a>
  </li>

  <!-- Google Plus -->
  <li class="social item hvr-grow-rotate">
    <a target="blank" href="https://plus.google.com/+PandichiAlinIonut" title="Alin Pandichi on Google Plus">
      <i class="icon icon-social-google-plus"></i>
      <span class="label">Google Plus</span>
    </a>
  </li>

  <!-- Google Plus -->
  <li class="social item hvr-grow-rotate">
    <a target="blank" href="http://stackoverflow.com/users/3177496/alin-pandichi" title="Alin Pandichi on Stack Overflow">
      <i class="icon icon-social-stack-overflow"></i>
      <span class="label">Stack Overflow</span>
    </a>
  </li>

  <!-- RSS -->
  <li class="social item hvr-grow-rotate">
    <a href="../rss/index.rss" title="Subscribe to RSS">
      <i class="icon icon-rss"></i>
      <span class="label">RSS</span>
    </a>
  </li>

  </ul>
</nav>
          <section class="icon icon-search" id="search-container">
  <hr class="divider short">
  <form id="search-form">
    <input type="text" name="search" placeholder="git, css, javascript,..." id="search-field">
  </form>
</section>
        </div>
      </div>
    </div>
  </div>
</aside>

  <main>
    <section id="search-results"></section>
    <section class="content">
      

  <article class="post tag-cordova tag-sqlite tag-websql">
    <header>
      <div class="post meta">
        <time datetime="15 Nov 2015">15 Nov 2015</time>
        <span class="post tags">in <a href="../tag/cordova/">cordova</a> <a href="../tag/sqlite/">sqlite</a> <a href="../tag/websql/">websql</a></span>
        <span class="post reading-time"> – <span></span> read.</span>
      </div>

      <a id="share_twitter" alt="Tweet 'Testing Cordova SQLite queries with Web SQL'" target="_blank">
        
        <h1 class="icon-reverse icon-social-twitter-post" id="post-title">Testing Cordova SQLite queries with Web SQL.</h1>
      </a>
    </header>

    <div id="post-content" class="post tag-cordova tag-sqlite tag-websql">
      <p>Once you start writing SQL queries for your Cordova application, you need to start thinking about how to make sure they work as expected. You'd want to test them in an automated fashion, but you're not ready to invest into a physical mobile device testing rig and you're not fond of emulators either. You want a fast feedback loop, something like running Jasmine tests in a browser. Luckily for you, the Cordova-sqlite-storage plugin emulates the Web SQL API as closely as possible. Let's see how you can leverage that in order to build a few Jasmine tests that validate your SQL queries.</p>

<h3 id="thequeriesweneedtotest">The queries we need to test</h3>

<p>My Cordova application is using Ionic (and implicitly AngularJS) and it implements two SQL queries: <code>insertPerson</code>  and <code>selectPerson</code>. They can be executed through an AngularJS service named <code>DatabaseService</code>.</p>

<pre><code class="language-prettyprint javascript">    angular.module('starter', ['ionic', 'ngCordova'])
        .service('DatabaseService', function($ionicPlatform, $cordovaSQLite, LoggingService, $q) {
            var db;
            window.document.addEventListener('deviceready', function() {
                db = $cordovaSQLite.openDB({
                    name: "mydb",
                    bgType: 1
                });
            }, false);

            this.insertPerson = function(firstname, lastname, address) {
                var query = "INSERT INTO person (firstname, lastname, address) VALUES (?, ?, ?)";
                var args = [firstname, lastname, address]
                var promise = $cordovaSQLite.execute(db, query, args)
                    .then(function(result) {
                        return result.insertId;
                    });
                return promise;
            };

            this.selectPerson = function(id) {
                var query = "SELECT * FROM person WHERE id = ?";
                var promise = $cordovaSQLite.execute(db, query, [id])
                    .then(function(result) {
                        var person = result.rows.item(0);
                        return person;
                    });
                return promise;
            };

            return this;
        });
</code></pre>

<h3 id="replacingsqlitepluginwithwebsql">Replacing sqlitePlugin with Web SQL</h3>

<p>The key to the whole thing is to replace the <code>window.sqlitePlugin</code> object with one whose <code>openDatabase</code> function returns the equivalent of Web SQL.</p>

<pre><code class="language-prettyprint javascript">window.sqlitePlugin = {};  
window.sqlitePlugin.openDatabase = function() {  
  return window.openDatabase('mydb', '1.0', 'myDatabase', 10000000);
};
</code></pre>

<h3 id="creatingthedatabaseschema">Creating the database schema</h3>

<p>We will need a function that takes in an array of DDL queries to be executed in order to create the database schema.</p>

<pre><code class="language-prettyprint javascript">var processQueries = function(db, queries, dbname) {  
  db.transaction(function(tx) {
    for (var idx = 0; idx &lt; queries.length; idx++) {
      tx.executeSql(queries[idx], [], 
        function() {
          console.log('done');
        },
        function(tx, err) {
          console.log('error: ' + err.message);
        }
      );
    }
  });
};
</code></pre>

<p>We can fetch and process these DDL queries from an online storage.</p>

<pre><code class="language-prettyprint javascript">$.ajax({
  url: 'https://cdn.rawgit.com/apandichi/demos/eaf2109abc17f90f6cad8340e0b491eca90aa766/db-migrations-cordova/www/spec/db-schema.sql',
  type: 'get',
  async: false,
  success: function(response) {
    var db = openDatabase('mydb', '1.0', 'myDatabase', 10000000);
    var queries = response.split(';\n');
    processQueries(db, queries, 'myDatabase');
  },
  error: function(response) {
    console.log("error!", JSON.stringify(response));
  }
});
</code></pre>

<h3 id="jasminesetup">Jasmine setup</h3>

<p>The replacement of <code>sqlitePlugin</code> and the creation of the database schema needs to happen just once before running all the Jasmine tests in your suite. This means that you'll have to wrap those code snippets above into a Jasmine <code>beforeAll</code> function. As of version 2.1 of Jasmine, this function is available out of the box. If you're using an earlier version, you can add <a href="https://github.com/nonplus/jasmine-beforeAll">jasmine-beforeAll</a> to your test dependencies, which will enable the needed hook.</p>

<p>Also, in my case, I need to inject the <code>DatabaseService</code> into the test, to manually trigger the <code>deviceready</code> event, and to provide an implementation (<a href="https://github.com/kriskowal/q">the Q library</a>) to the AngularJS <code>$q</code> promise service.</p>

<pre><code class="language-prettyprint javascript">    var DatabaseService;

    beforeEach(function() {        
      angular.mock.module("starter");
      angular.mock.module(function ($provide) {
        $provide.value('$q', Q);
      });

      inject(function(_DatabaseService_) {
        DatabaseService = _DatabaseService_;
        helper.trigger(window.document, 'deviceready');
      });
    });
</code></pre>

<h3 id="theactualjasminetest">The actual Jasmine test</h3>

<p>The following test will insert a person into the database, retrieve the person record based on the inserted id, and it will make assertions on the retrieved result.</p>

<pre><code class="language-prettyprint javascript">    it("should save person into the database", function() {
      runs(function() {
        var promise = DatabaseService.insertPerson("Jon", "Arbuckle", "Somewhere in the US")
          .then(function (insertId) {
            return DatabaseService.selectPerson(insertId)
          });
        return promise;
      }, function(result) {
        expect(result.firstname).toBe("Jon");
        expect(result.lastname).toBe("Arbuckle");
        expect(result.address).toBe("Somewhere in the US");
      });
</code></pre>

<h3 id="seethefullexample">See the full example</h3>

<p>You can check out the full code example on Github: <a href="https://github.com/apandichi/demos/tree/master/db-migrations-cordova">db-migrations-cordova</a>. It builds upon the previous article about database migrations in Cordova. <br>
The most relevant files for this blogpost are:</p>

<ul>
<li>www/js/app.js - the AngularJS application</li>
<li>www/spec/index.js - the Jamine test file</li>
<li>www/spec.html - an HTML test runner. Load this in a browser that supports Web SQL, such as Google Chrome. You should be able to see the passing test, and to inspect the Web SQL tables with Chrome's Dev Tools.</li>
</ul>
    </div>

    <div class="post related">
        <a id="prev-btn" class="btn small square" href="../database-migrations-in-cordova/">← Database migrations in Cordova</a>

    </div>

    <footer class="post comments">
  <div id="disqus_thread"></div>
  <script type="text/javascript">
  // required: replace example with your forum shortname
  var disqus_shortname = 'apandichi';
  /* * * DON'T EDIT BELOW THIS LINE * * */
  (function() {
  var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
  dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
  </script>
  <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
  <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</footer>

  </article>


      <footer>
  <script src="https://cdn.rawgit.com/google/code-prettify/master/loader/run_prettify.js"></script>
  <span class="copyright">
    © 2015. All rights reserved. Built with <a href="https://ghost.org/" target="_blank">Ghost</a> and <a href="https://github.com/Kikobeats/uno-zen" target="_blank">Uno Zen</a> theme.
  </span>
</footer>
    </section>
  </main>

  <script src="../public/jquery.js?v=3c08806173"></script>
  <script type="text/javascript" src="../assets/js/uno.js?v=3c08806173"></script>
  <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-34372837-2', 'auto');
  ga('require', 'linkid', 'linkid.js');
  ga('send', 'pageview');
</script>
</body>
